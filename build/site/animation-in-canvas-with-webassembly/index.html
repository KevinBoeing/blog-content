<!doctype html>
<html lang="en">
<head>
    <title>A Note on Animation in Canvas with WebAssembly</title>
    <meta name="description" content="Giving back control of the game rendering loop to the WebAssembly module. Partly.">
    <meta name="author" content="Tomas Tulka">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@tomas_tulka">
    <meta name="twitter:creator" content="@tomas_tulka">
    <meta name="twitter:title" content="A Note on Animation in Canvas with WebAssembly by Tomas Tulka">
    <meta name="twitter:image:src" content="https://blog.ttulka.com/assets/img/blog.jpg">
    <meta property="og:url" content="https://blog.ttulka.com/animation-in-canvas-with-webassembly" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="A Note on Animation in Canvas with WebAssembly by Tomas Tulka" />
    <meta property="og:image" content="https://blog.ttulka.com/assets/img/blog.jpg">

    <link href="/assets/css/syntaxhighlighter.css" rel="stylesheet">
    <link href="/assets/css/blog.2.7.css" rel="stylesheet">
</head>
<body>

<header class="header">
    <div class="container">
        <nav class="nav">
            <a class="active" href="/">Home</a>
            <a href="/about">About</a>
        </nav>
        <div class="ext-links">
            <a href="https://twitter.com/tomas_tulka"><img src="/assets/img/twitter.png"></a>
            <a href="https://github.com/ttulka"><img src="/assets/img/github.png"></a>
            <a href="#" class="theme"><img src="/assets/img/theme.png"></a>
        </div>
    </div>
</header>

<main class="main">

    <article class="blog-post">
    <h1 class="blog-post__title">A Note on Animation in Canvas with WebAssembly</h1>
    <p class="blog-post__meta">2021-07-21 by Tomas Tulka</p>
    <p>Giving back control of the game rendering loop to the WebAssembly module. Partly.</p>
    <hr>
    <p>In the previous post about <a href="/2d-video-game-in-assemblyscript-tutorial">building a 2D Video Game in AssemblyScript</a>, we have inversed the control loop and gave the JS glue code the job to render the game animation.</p>

<p>This means, the browser, not the game, is in control of the frame rate:</p>

<pre class="brush: javascript">
const updateCall = () => update(wasm, mem, imageData, argb);
setInterval(updateCall, 100); // frame rate

// ...

function update(wasm, mem, imageData, argb) {
  // call the Wasm module to update the game
  wasm.update(control);

  // render the game on canvas
  argb.set(mem.subarray(0, WIDTH * HEIGHT));
  ctx.putImageData(imageData, 0, 0);
}
</pre>

<p>This works fine for the example, but in a real-world scenario, we usually don’t want to move the game settings (such as frame rate) out of the game logic.</p>

<h2>Synchronous canvas rendering</h2>

<p>A naive approach would be to put the rendering loop into the Wasm module:</p>

<pre class="brush: typescript">
export declare function render(): void

// ...

start(): void {
  // ...

  while (true) {
    this.update();  // update the game
    render();       // request rendering
    this.sleep();   // wait based on FPS
  }
}
</pre>

<p>The function render would be imported into the module from JS and would take care of the canvas rendering:</p>

<pre class="brush: javascript">
const wasm = await WebAssembly
  .instantiateStreaming(fetch('../build/optimized.wasm'), {
    render: () => render(wasm, imageData, argb),
    // ...

function render(wasm, imageData, argb) {
  const mem = new Uint32Array(wasm.memory.buffer);

  argb.set(mem.subarray(0, WIDTH * HEIGHT));
  ctx.putImageData(imageData, 0, 0);
}
</pre>

<p>The problem with this approach is that it won’t work. In fact, nothing will be rendered as calling <code>ctx.putImageData</code> is truly <strong>synchronous and will wait until the script ends</strong>. And that never happens because of <code>while(true)</code>.</p>

<h2>Giving control back to the game</h2>

<p>Obviously, we cannot get rid of the rendering loop in JS but at least we can control the frame rate within the game.</p>

<p>We will use <code>Window.requestAnimationFrame()</code> for the loop that renders the game usually 60 times per second:</p>

<pre class="brush: javascript">
const updateCall = () => {
  update(wasm, mem, imageData, argb);
  window.requestAnimationFrame(updateCall);
}
window.requestAnimationFrame(updateCall);
</pre>

<p>60 FPS is definitely too much for our demo game. We have to control the rate in the game. We will check if the game is ready to update and only then we perform the update. We simply return otherwise:</p>

<pre class="brush: typescript">
update(control: Controls): void {
  if (!this.readyToUpdate()) {
    return;
  }
  // update the game
  // ...
}

private readyToUpdate(): boolean {
  const now = Date.now();
  if (now > this.lastUpdate + 1000 / FPS) {
    this.lastUpdate = now;
    return true;
  }
  return false;
}
</pre>

<p>Now, the browser still controls the animation loop, but the <strong>game defines its frame rate</strong>.</p>

<p>Check out the source code in an <a href="https://github.com/ttulka/2d-videogame-in-assemblyscript/tree/requestAnimationFrame">alternative branch on my GitHub</a>.</p>

<p>Happy animating!</p>


</article>

<aside class="blog-tags">
    
    <a href="/tag/AssemblyScript" class="tag">AssemblyScript</a>
    
    <a href="/tag/WebAssembly" class="tag">WebAssembly</a>
    
    <a href="/tag/Programming" class="tag">Programming</a>
    
    
</aside>

<aside class="blog-comments">
    <h2>Leave a message</h2>
    <p class="leave-message">You can add a comment to this post by <a href="https://github.com/ttulka/blog-content/edit/main/site/comments/animation-in-canvas-with-webassembly.json">opening a pull request</a> (see <a href="https://github.com/ttulka/blog-content#add-a-new-comment">HowTo</a>).</p>

    
    
    
</aside>

</main>

<footer class="footer">
    <div class="container">
        <div class="footer__extended">© 2021 Tomas Tulka (ttulka)</div>
        <div class="footer__menu">
            <a href="/">Home</a> |
            <a href="/privacypolicy/">Privacy Policy</a>
        </div>
    </div>
</footer>

<script src="/assets/js/darktheme.js"></script>
<script src="/assets/js/syntaxhighlighter.min.js" defer></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZKWY8T55EM"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-ZKWY8T55EM');
</script>

</body>
</html>