<!doctype html>
<html lang="en">
<head>
    <title>JavaScript async/await in a Loop</title>
    <meta name="description" content="Async/await syntax is a great technique how to deal with promises in modern JavaScript. Unfortunately it's not always easy to understand how it works which can lead to strange bugs. Let's investigate one of them.">
    <meta name="author" content="Tomas Tulka">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.png">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@tomas_tulka">
    <meta name="twitter:creator" content="@tomas_tulka">
    <meta name="twitter:title" content="JavaScript async/await in a Loop by Tomas Tulka">
    <meta name="twitter:image:src" content="https://blog.ttulka.com/assets/img/blog.jpg">
    <meta property="og:url" content="https://blog.ttulka.com/javascript-async-await-in-a-loop" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="JavaScript async/await in a Loop by Tomas Tulka" />
    <meta property="og:image" content="https://blog.ttulka.com/assets/img/blog.jpg">

    <link href="/assets/css/syntaxhighlighter.css" rel="stylesheet">
    <link href="/assets/css/blog.2.7.css" rel="stylesheet">
</head>
<body>

<header class="header">
    <div class="container">
        <nav class="nav">
            <a class="active" href="/">Home</a>
            <a href="/about">About</a>
        </nav>
        <div class="ext-links">
            <a href="https://twitter.com/tomas_tulka"><img src="/assets/img/twitter.png"></a>
            <a href="https://github.com/ttulka"><img src="/assets/img/github.png"></a>
            <a href="#" class="theme"><img src="/assets/img/theme.png"></a>
        </div>
    </div>
</header>

<main class="main">

    <article class="blog-post">
    <h1 class="blog-post__title">JavaScript async/await in a Loop</h1>
    <p class="blog-post__meta">2018-11-03 by Tomas Tulka</p>
    <p>Async/await syntax is a great technique how to deal with promises in modern JavaScript. Unfortunately it's not always easy to understand how it works which can lead to strange bugs. Let's investigate one of them.</p>
    <hr>
    <p>There is a service in our system cleaning up unused resources. Those resources are grouped upon an ID. So the request looks like "remove all the resources for the ID 123".</p>
<p>In the service code I have found the following line:</p>

<pre class="brush: javascript">
entryKeys.forEach(async key => await removeResource(key))
</pre>

<p>Why this doesn't work? Let's analyse the code a bit. The <code>forEach</code> is just a stream variant of the <code>for</code> loop and it's definitely synchronous. So, there shouldn't be the problem even when it's a bit ineffective. Inside the <code>forEach</code> there is a call of the <code>removeResource</code> function with <code>await</code>. The <code>await</code> tells us that the function returns a promise. The <code>await</code> can be used only within an <code>async</code> function which is fulfilled because the inline (lambda) function is really marked with the <code>async</code> keyword (we can rewrite the same function as <code>async function(key){ await removeReource(key) }</code>). The point is a function declared with <code>async</code> returns always a promise. It means, the <code>forEach</code> fires several <b>asynchronous</b> calls but <b>doesn't wait for them</b> (<code>await removeResource(key)</code> is another asynchronous call inside that asynchronous call).</p>

<p>Now, when we understand why the code doesn't work, we can fix it:</p>

<pre class="brush: javascript">
for (const key of entryKeys) { await removeResource(key) }
</pre>

<p>This works fine, the only problem is, it's synchronous and slow. The loop is waiting for an execution to finish before starting a new one even when it is possible to run them all in parallel.</p>
<p>Can we fix it? Sure!</p>

<pre class="brush: javascript">
await Promise.all(entryKeys.map(key => removeResource(key)))
</pre>

<p>We have changed <code>forEach</code> to <code>map</code>, so we map an array of IDs into an array of promises. Then we pack the promises into a one big promise via <code>Promise.all()</code>. Now we wait for the big promise (and that's exactly what we missed before) to be completed. All the call are executed in parallel. Well done.</p>

<p>You can play with the different variants via the following snippet:</p>

<pre class="brush: javascript">
(async function(){
    console.log("START")

    // doesn't work
    //["A","B","C"].forEach(async key => await doSomethingAsync(key))

    await Promise.all(["D","E","F"].map(key => doSomethingAsync(key)))

    // synchronous
    //for (const key of ["G","H","I"]) { await doSomethingAsync(key) }

    console.log("END")
})()

function doSomethingAsync(key) {
    return new Promise(function (resolve, reject) {
        setTimeout(() => {
            console.log("RESOLVED " + key)
            resolve(key)
        }, 1000)
    })
}
</pre>

<h2>What about Reduce?</h2>

<p>How could we reduce the value from the promises? Well, of course the reduce needs the already resolved values:</p>

<pre class="brush: javascript">
// "JKL"
var result = await ["J","K","L"]
      .map(key => doSomethingAsync(key))
      .reduce(async (sum,v) => await sum + await v)
</pre>

<p>Because the whole reduce function is <code>async</code> we have to use <code>await</code> as well to retrieve the value of <code>sum</code>.</p>

<p>Happy promising!</p>

</article>

<aside class="blog-tags">
    
    <a href="/tag/Programming" class="tag">Programming</a>
    
    <a href="/tag/JavaScript" class="tag">JavaScript</a>
    
    
</aside>

<aside class="blog-comments">
    <h2>Leave a message</h2>
    <p class="leave-message">You can add a comment to this post by <a href="https://github.com/ttulka/blog-content/edit/main/site/comments/javascript-async-await-in-a-loop.json">opening a pull request</a> (see <a href="https://github.com/ttulka/blog-content#add-a-new-comment">HowTo</a>).</p>

    
    
    
</aside>

</main>

<footer class="footer">
    <div class="container">
        <div class="footer__extended">Â© 2021 Tomas Tulka (ttulka)</div>
        <div class="footer__menu">
            <a href="/">Home</a> |
            <a href="/privacypolicy/">Privacy Policy</a>
        </div>
    </div>
</footer>

<script src="/assets/js/darktheme.js"></script>
<script src="/assets/js/syntaxhighlighter.min.js" defer></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZKWY8T55EM"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-ZKWY8T55EM');
</script>

</body>
</html>